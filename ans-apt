#!/bin/bash

# Shell Script that will auto-call ansible-playbook for me

# Copyright Â© 2017 JPCDI, JPartain89 and Justin Partain
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

PROGRAM_NAME="ans-apt"
PROGRAM_AUTHOR_CONTACT="${PROGRAM_NAME}_noreply@jpcdi.com"
PROGRAM_AUTHOR_FULL="JPCDI, JPartain89 and $PROGRAM_AUTHOR"
VERSION="3.0"

if [[ ! -e "$(which allunix)" ]]; then
    echo "AllUnix file is missing."
    wget -O - http://bit.ly/jp_allunix | bash
fi

source allunix
ANSIBLE-SOURCING

GEN_SCRIPTS="$HOME/git/generalscripts"
GEN_ANS="$GEN_SCRIPTS/ansible"

no_sudo

vm_sutdown_text () {
cat <<- EOF
${RED}################################################################################

           ARE YOU SURE YOU WANT YOUR VIRTUAL MACHINES TO SHUTDOWN??

################################################################################

                           These machines are:

 			       Downloader
 			      NGINX-Server
			       Web Server

###############################################################################${NORMAL}
EOF
}

help_text () {
cat <<- EOF
My personal shortcutting ansible stuffs!

ans-apt [-ua | -uL | -uv | -ul and etc. ]

Options:
    -ua, --update-all       : Updates all Managed Machines:
                            :   Apt, Homebrew and Pip
                            :   Runs map-pull-sub from conffiles outward
                            :   (Local and Remote, macOS and Linux)
    -ul, --update-local     : Updates all Local Machines
                            :   Apt, Homebrew and Pip
                            :   Runs map-pull-sub from conffiles outward
                            :   (RPI, Virtual and macOS locally)
    -u, --update-linux      : Updates Linux Machines
                            :   Apt and Pip
                            :   Runs map-pull-sub from conffiles outward
                            :   (Local and Remote Linux Machines)

    -pa, --pip-all          : Updates Pip on all Machines
    -pl, --pip-local	    : Updates Pip on Local Machines
    -p, --pip-linux	    : Updates Pip on all Linux Machines

    -ma, --map-all          : Runs map-pull-sub from conffiles outward
                            :   on all managed machines
    -ml, --map-local        : Runs map-pull-sub from conffiles outward
                            :   on all local machines

    -rl, --reboot-linux     : Reboots the Linux Machines
    -rv, --reboot-virtual   : Reboots all Virtual Machines

    -m,  --monit            : Reloads monit on all Managed Machines

    -sl, --shutdown-linux   : Shutdown Linux Machines
    -sv, --shutdown-virtual : Shutdown Virtual Machines

There is not currently an option to shutdown all Managed Linux Machines

    -h,  --help             : this help
EOF
}

while [ $# -ge 1 ]; do
    case "$1" in
        -ua | --update-all )
            echo "";
            echo "Updating all Managed Machines";
            ansible-playbook "$GEN_ANS/apt_basic.yml";
            ansible-playbook "$GEN_ANS/brew_basic.yml";
            ansible-playbook "$GEN_ANS/map-pull-sub.yml";
            exit 0
            ;;
        -ul | --update-local )
            echo "";
            echo "Updating only Local Machines";
            ansible-playbook "$GEN_ANS/apt_basic.yml" --limit=local-linux;
            ansible-playbook "$GEN_ANS/brew_basic.yml";
            ansible-playbook "$GEN_ANS/map-pull-sub.yml" --limit=local-linux;
            exit 0
            ;;
        -ul | --update-linux )
            echo "";
            echo "Updating Linux Machines ";
            ansible-playbook "$GEN_ANS/apt_basic.yml" --limit=linux;
            ansible-playbook "$GEN_ANS/map-pull-sub.yml" --limit=linux;
            exit 0
            ;;
        -pa | --pip-all )
            echo "";
            echo "Updating Pip on all Managed Machines ";
            ansible-playbook  "$GEN_ANS/pip-playbook.yml";
    	    exit 0
            ;;
        -pm | --pip-mac )
            echo "";
            echo "Updating Pip on all macOS machines.";
            ansible-playbook "$GEN_ANS/pip-playbook.yml"--limit=macos;
		    exit 0
        ;;
        -pl | --pip-linux )
            echo "";
            echo "Updating Pip on Linux Machines ";
            ansible-playbook  "$GEN_ANS/pip-playbook.yml" --limit=linux;
            exit 0
            ;;
        -ma | --map-all )
            echo "";
            echo "Running map-pull-sub from within conffiles repo";
            ansible-playbook "$GEN_ANS/map-pull-sub.yml";
            exit 0;;
        -ml | --map-local )
            echo "";
            echo "Running map-pull-sub from within conffiles repo";
            ansible-playbook "$GEN_ANS/map-pull-sub.yml" --limit=local-linux;
            exit 0;;
        -rl | --reboot-linux )
            echo "";
            echo "Rebooting Linux Machines ";
            ansible-playbook  "$GEN_ANS/restart.yml";
            exit 0
            ;;
        -rv | --reboot-virtual )
            echo "";
            echo "Rebooting only Virtual Machines ";
            ansible-playbook  "$GEN_ANS/restart.yml" --limit=virtual;
            exit 0
            ;;
        -m | --monit )
            echo "";
            echo "Reloads monit on Linux Machines ";
            ansible  linux -s -m service -a 'name=monit state=reloaded';
            exit 0
            ;;
        -sl | --shutdown-linux )
            dialog --yesno "Do you want ALL of the Linux Machines to shutdown?" 0 0
            rc=$?
            if [[ "${rc}" == "0" ]]; then
                ansible-playbook "$GEN_ANS/shutdown.yml"
                exit 0
            else
                    exit 1
            fi
            ;;
        -sv | --shutdown-virtual )
            dialog --yesno "Do you want ALL of the VIRTUAL MACHINES to shutdown?" 0 0
            rc=$?
            if [[ "${rc}" == "0" ]]; then
                ansible-playbook "$GEN_ANS/shutdown.yml" --limit=virtual
                exit 0
            else
                exit 1
            fi
            ;;
        -h | --help )
            help_text &&
            exit 0
            ;;
        * )
            help_text &&
            exit 1
            ;;
    esac
done

if [[ $1 == "" ]]; then
    help_text
    exit 1
fi

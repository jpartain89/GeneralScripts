#!/usr/bin/env bash
set -e

PROGRAM_NAME=ssdc
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
REPO_NAME="generalscripts"

# File/Directory based variables
DF_LOCATION="${HOME}/git/docker_directory"
DF=docker-compose.yml
DF_CHILD_LOCATIONS=$(cat ${DF_LOCATION}/ssdc.conf)
eval ~/git/generalscripts/bash/functions/bash_functions
# "${DF_LOCATION}/ssdc.conf"

_logging;

# Program based Variables
DOCKER="$(command -v docker)"
DOCKER_CMD="${DOCKER} compose -f"

trap "die 'trap called'" SIGHUP SIGINT SIGTERM

_link_install

git_pull() {
    # Pulls the main repo for us
    echo "**** Checking for updates to the docker repo ****"
    cd "${DF_LOCATION}" || exit
    git pull
    cd - || exit
}

op_process() {
    # Force sign-in to 1Password-CLI
    until eval $(op signin) ; do
        echo "Looks like you failed the password prompt! Try again in 10 seconds!"
        sleep 10
    done

    # Walks through all the found .tpl files
    while IFS=\n read -r file; do
        for i in "${file}"; do
            if [[ -e "${i}" ]]; then
                op inject --force -i "${i}" -o "${i%.*}"
            fi
        done
    done< <(find "${DF_LOCATION}" -iname "*.tpl" -exec echo {} \;)
}

start_containers() {
    while IFS= read -r file; do
        for i in "${file}"; do
            ${DOCKER_CMD} ${DF_LOCATION}/${i}/${DF} pull &&
            ${DOCKER_CMD} ${DF_LOCATION}/${i}/${DF} up -d --remove-orphans
        done
    done< <(echo "${DF_CHILD_LOCATIONS}")

    ${DOCKER_CMD} ${DF_LOCATION}/${DF} pull &&
    ${DOCKER_CMD} ${DF_LOCATION}/${DF} up -d --remove-orphans
}

stop_containers() {
    while IFS= read -r file; do
        for i in "${file}"; do
            ${DOCKER_CMD} ${DF_LOCATION}/${i}/${DF} down || true
        done
    done< <(echo "${DF_CHILD_LOCATIONS}")

    ${DOCKER_CMD} ${DF_LOCATION}/${DF} down || true
}

backup() {
    while IFS= read -r file; do
        for i in "${file}"; do
            if [[ "${i}" != "duplicati" ]]; then
                ${DOCKER_CMD} ${DF_LOCATION}/${i}/${DF} down || true
            fi
        done
    done< <(echo "${DF_CHILD_LOCATIONS}")
}

rm_op() {
    while IFS= read -r file; do
        for i in "${file}"; do
            if [[ -e "${i}" ]]; then
                rm "${i}"
            fi
        done
    done< <(find "${DF_LOCATION}" -iname "*.env" -exec echo {} \;)
}

if [ $? != 0 ] ; then
    die "Failed to parse options...exiting." >&2
fi

while (( "$#" )); do
    case "$1" in
        start )
            git_pull;
            start_containers;
            shift;;
        full_start | full-start )
            git_pull;
            op_process;
            start_containers;
            shift;;
        stop )
            stop_containers;
            shift;;
        full_stop | full-stop )
            stop_containers;
            rm_op;
            shift;;
        op )
            op_process;
            shift;;
        backup )
            backup;
            shift;;
        * )
            trap;
            exit;;
    esac
done


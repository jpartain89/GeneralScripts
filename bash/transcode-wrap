#!/usr/bin/env bash
set -e

#This is to call 'transcode-video' in batch-form

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

PROGRAM_NAME="transcode-wrap"
REPO_NAME="generalscripts"

. ~/.config/functions/bash_functions

_link_install
_trap
_logging
#_getopt_test

TRANSCODE="$(command -v transcode-video)"

if [[ "${TRANSCODE}" == "" ]]; then
  echo "You don't have the necessary program."
  echo "You need to install ${TRANSCODE}"
  exit 1
fi

usage() {
  echo -e "
${PROGRAM_NAME} [ -l | --location ] /foo/bar [ -e | --extension ] .bar

    -l | --location    : Sets the directory location for the files you are
                          wanting trascoded.
    -e | --extension   : Sets the extension of the files you want transcoded

    ${_red}NOTE: Can only parse one at time for both items.${_end}
      This one is allowed:
        ${_redb}${PROGRAM_NAME} -l /media/drive -e .mkv${_end}
      This one is not:
        ${_redb}${PROGRAM_NAME} -l /media/drive -l /some/other/spot -e .mkv,.avi${_end}

"
}

main() {
  while IFS= read -r file; do
    for i in "$file"; do
      if [[ ! -e "${i%${EXT}}mp4" ]]; then
        transcode-video --quick --mp4 "${i}" "${i%${EXT}}mp4"
      elif [[ -e "${i%${EXT}}mp4" ]]; then
        echo "${i${EXT}" "${i${EXT}}.log"
        #rm "${i${EXT}" "${i${EXT}}.log"
      fi
    done;
  done< <(find "${LOCATION}" -iname "*${EXT}" -exec echo {} \;)
}

#SHORT=leh
#LONG=location,ext,help

#OPTS=$(${GETOPT} --options ${SHORT} --long ${LONG} --name "$0" -- "$@")

if [ "${#}" == 0 ] ; then
  _trap_die "Failed to parse options as there aren't any... exiting." >&2
fi

#eval set -- "${OPTS}"

while (( "${#}" )); do
  case "${1}" in
    -l | --location )
      LOCATION="${2}";
      shift;
      ;;
    -e | --extension )
      EXT="${2}"
      [[ ${EXT} != .* ]] && EXT=".${EXT}"
      shift;
      ;;
    -h | --help )
      usage
      exit 0
      ;;
    -- )
      shift
      break
      ;;
    * ) # preserve positional arguments
      PARAMS="${PARAMS} ${1}"
      shift
      ;;
  esac
done

main

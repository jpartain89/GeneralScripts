#!/usr/bin/env bash

PROGRAM_NAME="auto-handbrake"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
SOURCE="$1"

LOG_DIR="/var/log/$PROGRAM_NAME/"

die() {
    echo "$program: $1" >&2
    exit "${2:-1}"
}

help() {
    cat << EOF
auto-handbrake [directory location]

This script is to automatically run HandBrakeCLI with specific preset settings.
You need to include the directory location of the movies you want re encoded.
EOF
}

trap "die 'trap called'" SIGHUP SIGINT SIGTERM

# This "auto-installs" git-autopull into /usr/local/bin for ya!
command -v "$PROGRAM_NAME" 1>/dev/null 2>&1 || {
    (
        if [ -x "${DIR}/${PROGRAM_NAME}" ]; then
            sudo ln -svf "${DIR}/${PROGRAM_NAME}" "/usr/local/bin/${PROGRAM_NAME}"
            sudo chmod -R 0775 "/usr/local/bin/${PROGRAM_NAME}"
        else
            echo "For some reason, linking $PROGRAM_NAME to /usr/local/bin,"
            echo "failed. My apologies for not being able to figure it out..."
            exit 1
        fi
    )
}

test -x "$(command -v HandBrakeCLI)" || die "Looks like HandBrakeCLI is missing."

if [[ "$#" -lt 1 ]]; then
    help && die
fi

# These are the 'general' file extensions that I use.
FIND_ARGS='\( -iname "*avi" -o -iname "*wmv" -o -iname "*mov" -o -iname "*flv" -not "*mp4" -not "*mkv" \)'

PRESET="Apple 1080p60 Surround"

while [[ "$?" -ge 1 ]]; do
    case "$SOURCE" in
        -h ) help;;
        * ) help;;
    esac
done

while IFS= read -r line; do
    output="${line%\.[^.]*}.mp4"

    HandBrakeCLI -Z "${PRESET}" --input "${line}" \
        --output "${output}" < /dev/null

done < <(find "$SOURCE" "${FIND_ARGS}" -exec echo {} \; ) >> "${LOG_DIR}/${PROGRAM_NAME}.log" 2>&1 &
